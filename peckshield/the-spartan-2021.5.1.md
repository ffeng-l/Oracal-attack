# The Spartan（2021.5.1）

### 分析

{% embed url="https://blog.peckshield.com/2021/05/02/Spartan" %}

### 攻击原因

这一事件是由于在烧毁资金池代币提取基础资产时，计算流动性份额的逻辑有缺陷。特别是，攻击者在燃烧相同数量的池子代币以索取不必要的大量基础资产之前，夸大了池子的资产余额。这种攻击的后果导致受影响的资金池损失超过3000万美元。

### 攻击流程

1. 攻击者首先通过闪电贷从PancakeSwap借出1000 WBNB。
2. 攻击者在出现漏洞的 Spartan兑换池WBNB-SPT1中,分五次将 WBNB兑换成 SPARTAN,从而导致兑换池中产生巨大滑点。
3. 攻击者将这些Token(持有的WBNB与SPARTA)注入WBNB-SPT1交易池中添加流动性,获得LP凭证,由于滑点修正机制,获得的LP数量并不是正常值。
4. 进行多次Swap操作,将WBNB兑换成SPARTA,池中WBNB增多,SPARTA减少。
5. Swap后将持有的WBNB和SPARTA转移给WBNB-SPT1池,进行移除流动性操作。移除流动性时会通过池中实时的代币数量来计算用户的LP可获得多少对应的代币,由于步骤5,此时会获得比添加流动性时更多的代币。
6. 在移除流动性后会更新流动性池中的baseAmount与tokenAmount,由于移除流动性时没有和添加流动性一样存在滑点修正机制,移除流动性后两种代币的数量和合约记录的代币数量会存在一定差值。在与实际有差值的情况下,攻击者继续添加流动性获得LP,然后攻击者再次移除流动性就获得了对应代币。
7. 最后,攻击者将SPARTA代币兑换回WBNB,获得了更多WBNB。
